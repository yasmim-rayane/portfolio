# ============================================================================
# CD para Branch Main (Produção)
# ============================================================================
# 
# Este workflow executa automaticamente em push na branch main.
# Realiza testes, versionamento automático e deploy em produção.
# 
# Fluxo completo:
# 1. Executa bateria completa de testes
# 2. Compila SASS para produção
# 3. Gera tag de versão automática (v1.0.0, v1.0.1, etc)
# 4. Efetua deploy no GitHub Pages
# ============================================================================

name: Main CD - Deploy Produção

# Executa apenas quando houver push na branch main
on:
  push:
    branches: [ main ]

# Permissões necessárias para deploy no GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # =========================================================================
  # Job 1: Testes completos de produção
  # =========================================================================
  test:
    name: Testes de Produção
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necessário para tags
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Instalar Sass
        run: npm install -g sass
      
      - name: Compilar SASS
        run: |
          sass --no-source-map assets/sass/style.scss assets/css/style.css
          echo "SASS compilado com sucesso"
      
      - name: Verificar build
        run: |
          if [ ! -f "assets/css/style.css" ]; then
            echo "CSS não foi gerado"
            exit 1
          fi
          echo "Build validado"
      
      - name: Validar HTML
        run: |
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "HTML inválido"
            exit 1
          fi
          echo "HTML válido"
      
      - name: Verificar JavaScript
        run: |
          js_files=$(find assets/script -name "*.js" -type f)
          for file in $js_files; do
            node --check "$file" || exit 1
          done
          echo "JavaScript validado"
  
  # =========================================================================
  # Job 2: Criar tag de versão automática
  # =========================================================================
  version:
    name: Criar Versão
    runs-on: ubuntu-latest
    needs: test
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch  # patch = v1.0.0 → v1.0.1
          release_branches: main
          tag_prefix: v
      
      - name: Anunciar versão
        run: |
          echo "Nova versão criada: ${{ steps.tag_version.outputs.new_tag }}"
          echo "Versão anterior: ${{ steps.tag_version.outputs.previous_tag }}"
  
  # =========================================================================
  # Job 3: Deploy para GitHub Pages
  # =========================================================================
  deploy:
    name: Deploy GitHub Pages
    runs-on: ubuntu-latest
    needs: [test, version]
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Instalar Sass
        run: npm install -g sass
      
      - name: Compilar SASS para produção
        run: |
          sass --no-source-map --style=compressed assets/sass/style.scss assets/css/style.css
          echo "CSS minificado para produção"
      
      - name: Configurar GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy para GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deploy concluído
        run: |
          echo "============================================================"
          echo "                                                            "
          echo "           DEPLOY REALIZADO COM SUCESSO                     "
          echo "                                                            "
          echo "  Versão: ${{ needs.version.outputs.new_tag }}              "
          echo "  Branch: main (produção)                                   "
          echo "  URL: ${{ steps.deployment.outputs.page_url }}             "
          echo "                                                            "
          echo "  Site atualizado e disponível online                       "
          echo "                                                            "
          echo "============================================================"
  
  # =========================================================================
  # Job 4: Criar GitHub Release com changelog
  # =========================================================================
  release:
    name: Criar Release
    runs-on: ubuntu-latest
    needs: [version, deploy]
    
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
      
      - name: Criar Release no GitHub
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.version.outputs.new_tag }}
          release_name: Release ${{ needs.version.outputs.new_tag }}
          body: |
            ## Portfolio Yasmim Rayane - ${{ needs.version.outputs.new_tag }}
            
            ### Changelog
            ${{ needs.version.outputs.changelog }}
            
            ### Melhorias desta versão
            - Código testado e validado
            - SASS compilado e minificado
            - Deploy automático realizado
            - Todos os testes passaram
            
            ### Deploy
            O site foi atualizado automaticamente no GitHub Pages.
            
            ---
            *Release criada automaticamente pelo GitHub Actions*
          draft: false
          prerelease: false
